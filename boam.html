<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BOAM Patronage Viewer</title>
  <style>
    :root {
      --main-color: #009ed7;
      --dark-color: #0e85b0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background-color: #f9f9f9;
      color: #333;
      line-height: 1.6;
    }

    h2 {
      color: #444;
      border-bottom: 2px solid var(--main-color);
      padding-bottom: 5px;
    }

    select {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
      background-color: #fff;
      transition: border-color 0.3s;
    }

    select#modeSelect {
      color: var(--main-color);
    }

    select:focus {
      border-color: var(--main-color);
      outline: none;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background-color: #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }

    th {
      background-color: #f4f4f4;
      color: #555;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tr:hover {
      background-color: #f1f1f1;
    }

    a.trip {
      color: var(--main-color);
      text-decoration: none;
      font-weight: bold;
      text-decoration: underline;
    }

    a.trip:hover {
      color: var(--dark-color);
    }

    footer {
      margin-top: 5%;
      padding: 20px;
      background-color: #f4f4f4;
      border-top: 1px solid #ddd;
      text-align: center;
    }

    footer a {
      color: var(--main-color);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    p.legal {
      font-size: 0.9rem;
      color: #666;
    }

    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      background-color: var(--main-color);
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: var(--dark-color);
    }

    div#passengerGraph {
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #fff;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      width: 100%;
      height: 400px;
    }

    div#tripData, div#stationData, div#routeSelect {
      display: none;
    }

    table#stopsTable {
      width: 60%
    }

    input[type="text"] {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
      background-color: #fff;
      transition: border-color 0.3s;
      width: 100%;
      max-width: 400px;
    }

    input[type="text"]:focus {
      border-color: var(--main-color);
      outline: none;
    }
  </style>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/searchpanes/2.1.2/css/searchPanes.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/searchpanes/2.1.2/js/dataTables.searchPanes.min.js"></script>
<script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
</head>

<body>
<h1>NSW Public Transport Load Insights</h1>
<h2>Select a Dataset and Station</h2>

<div>
  <select id="modeSelect">
    <option value="">Select a mode...</option>
  </select>
  <select id="dateSelect" style="display: none;">
    <option value="">Select a date...</option>
  </select>
</div>
<div id="routeSelect">
  <label for="routeSearch" style="font-weight: bold; margin: 5px 0px; display: block;">Choose Route:</label>
  <input type="text" id="routeSearch" spellcheck="false" autocomplete="off" placeholder="Enter route..." />
</div>

<div id="stationData">
  <h2>Services of Route <span id="routeId">xxx</span></h2>
  <p>Select a trip to view further details.</p>
  <table id="tripsTable">
    <thead>
      <tr>
        <th>Trip</th>
        <th>Route</th>
        <th>Direction</th>
        <th>From</th>
        <th>To</th>
        <th>At</th>
        <th>Peak Load</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<div id="tripData">
  <h2 id="tripPatronage">Patronage for Selected Trip</h2>
  <div id="passengerGraph"></div>
  <p style="color: darkred">Note: Transport only provides data in resolutions of 20, rounded down.<br>Therefore, a patronage of "0" actually represents anywhere from "0-20" passengers</p>

  <hr>
  <br>
  <div id="tripInfo"></div>
  <table id="stopsTable">
    <thead>
      <tr>
        <th>Stop #</th>
        <th>Station</th>
        <th>Time</th>
        <th># Passengers on arrival</th>
        <th>âˆ† Passengers</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<!-- File Loading Logic -->
<script>
  let servicesByStop = {};
  let servicesByRoute = {};
  let database = {};
  let stopList = {};
  let routeList = {};
  const getRouteLongName = (num) => `${num} - ${routeList[num]}`
  
  function loadJSON(filename) {
    // document.getElementById('stationSelect').innerHTML = '<option value="">Loading...</option>';
    // Fetch trips JSON

    fetch(filename)
      .then(response => filename.includes(".gz") ? response.arrayBuffer() : response.json())
      .then(data => {
        if (!(data instanceof ArrayBuffer)) return data;
        const compressed = new Uint8Array(data);
        return new Promise((resolve, reject) => {
          fflate.gunzip(compressed, (err, decompressed) => {
            if (err) reject(err);
            else resolve(JSON.parse(new TextDecoder().decode(decompressed)));
          });
        });
      })
      .then(trips => {
        // Build a map of station -> [tripname] for indexing on table
        servicesByStop = {};
        servicesByRoute = {}
        trips.forEach(trip => {
          trip.STOPS.forEach(([_, station]) => {
            if (!servicesByStop[station]) servicesByStop[station] = [];
            servicesByStop[station].push(trip.TRIP_ID);  
          });
          
          if (!servicesByRoute[trip.ROUTE]) servicesByRoute[trip.ROUTE] = [];
          servicesByRoute[trip.ROUTE.toUpperCase()].push(trip.TRIP_ID);
        });

        // Restructure trip data so that key is the tripname for fast indexing
        database = Object.fromEntries(
          trips.map(trip => [trip.TRIP_ID, trip])
        );

        validRoutes = Object.keys(servicesByRoute).map(v => [v, getRouteLongName(v)])
        populateAutocomplete('routeSearch', validRoutes);
      })
  }
  
  // Format 20250822 -> 22 Aug 2025
  const formatDate = yyyymmdd => {
    const [y, m, d] = [yyyymmdd.slice(0,4), yyyymmdd.slice(4,6), yyyymmdd.slice(6,8)];
    const date = new Date(parseInt(y), parseInt(m) - 1, parseInt(d))
    return [date, `${date.toLocaleString('en-US', { weekday: 'short' })} ${d} ${date.toLocaleString('en-US', { month: 'short' })} ${y}`]
  }

  // Fetch directory.json and populate mode and date selects
  fetch('./processed/directory.json')
    .then(res => res.json())
    .then(data => {
      const modeSelect = document.getElementById('modeSelect');
      const dateSelect = document.getElementById('dateSelect');
      const OAMs = {
        "ROAM": ["Trains", "#F37021"],
        "FOAM": ["Ferries", "#00774B"],
        "LOAM": ["Light Rail", "#BE1622"],
        "BOAM": ["Buses", "#009ed7"],
      };

      const groupedFiles = Object.groupBy(
        Object.entries(data)
          .flatMap(([dir, files]) => files.map(file => dir + file))
          .map(path => {
            const match = path.match(/([LRFB]OAM)_(\d{8})\.json/);
            if (!match) return null;
            const [_, type, dateStr] = match;
            return {path, type, dateStr, date: formatDate(dateStr)[0]};
          })
          .filter(Boolean),
          ({type}) => type // This is some wild syntax
      )

      // Populate mode dropdown
      Object.keys(groupedFiles).forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = OAMs[type][0];
        option.style.color = OAMs[type][1];
        modeSelect.appendChild(option);
      });

      // Handle mode selection
      modeSelect.addEventListener('change', () => {
        const selectedMode = modeSelect.value;
        if (selectedMode !== "BOAM") window.location.href = `./index.html?mode=${selectedMode}`
        dateSelect.innerHTML = '<option value="">Select a date...</option>';
        dateSelect.style.display = 'inline';

        groupedFiles[selectedMode]
          .sort((a, b) => b.date - a.date)
          .forEach(({path, dateStr}) => {
            const option = document.createElement('option');
            option.value = path;
            option.textContent = formatDate(dateStr)[1];
            dateSelect.appendChild(option);
          });

        // Hide all data, have only mode selector showing
        document.getElementById("routeSelect").style.display = "none";
        document.getElementById("stationData").style.display = "none";
        document.getElementById("tripData").style.display = "none";
      });

      // Default to buses
      modeSelect.value = "BOAM";
      modeSelect.dispatchEvent(new Event('change'));

      // Handle date selection
      dateSelect.addEventListener('change', () => {
        const selectedFile = dateSelect.value;
        if (selectedFile) {
          loadJSON(selectedFile);
          document.getElementById("routeSelect").style.display = "block";
        }
      });
    });

  // populates a textbox control with autocomplete, given dataset.
  // dataset array of the form [[value, display], [value, display]]
  function populateAutocomplete(searchControlId, dataset) {
    const control = document.getElementById(searchControlId);
    control.addEventListener('input', () => {
      const query = control.value.toLowerCase();
      const suggestions = dataset.filter(pair =>
        pair[1].toLowerCase().includes(query)
      );

      // Display suggestions
      const datalist = document.createElement('datalist');
      datalist.id = searchControlId + 'Suggestions';
      suggestions.forEach(([value, display]) => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = display;
        datalist.appendChild(option);
      });
      control.setAttribute('list', datalist.id);
      document.body.querySelector(`datalist#${datalist.id}`)?.remove();
      document.body.appendChild(datalist);
    });
  }

  // Fetch the stoplist and group by suburb
  fetch('./BOAM/stoplist.json')
    .then(response => response.json())
    .then(data => stopList = data);
  
  fetch('./BOAM/busroutes.json')
    .then(res => res.json())
    .then(routes => routeList = routes);
</script>

<!-- Data Vis Logic -->
<script>
  const GRAPH_MAX_POINTS = 12;
  const timeFormated = (timeStr) => timeStr.substring(0,5)

  function loadColour(load, capacity) {
    const ratio = load / capacity;
    if (ratio == 0) return "grey";
    if (ratio <= 0.25) return "green";
    if (ratio <= 0.5) return "darkorange";
    if (ratio <= 0.75) return "red";
    return "maroon";
  }


  // Handle route selection
  document.getElementById('routeSearch').addEventListener('input', () => {
    const route = document.getElementById('routeSearch').value.toUpperCase();
    document.getElementById("routeId").innerText = getRouteLongName(route);
    const tbody = document.querySelector('#tripsTable tbody');
    tbody.innerHTML = '';

    // Destroy datatables and clear current trip data
    const dataTable = $('#tripsTable').DataTable();
    dataTable.clear().destroy();
    document.getElementById('tripInfo').innerHTML = '';
    document.querySelector('#stopsTable tbody').innerHTML = '';
    document.getElementById('tripData').style.display = 'none';
    document.getElementById("stationData").style.display = "inline";

    function loadPercentage(num, max) {
      load = Math.floor(100 * (num > 0 ? num : 20) / max)
      if (num == 0) {
        return 0
      } 
      return `${load}%`;
    }
    String.prototype.toTitleCase = function () {return this.toLowerCase().replace(/\b\w/g, s => s.toUpperCase())};
    const getSuburb = id => stopList[id][1].toTitleCase();

    // Get trips of that route and then sort and then tabulate
    const sortedTrips = servicesByRoute[route]
      .map(i => database[i])
      .forEach(trip => {
        trip.ORIG_STN ??= getSuburb(trip.STOPS[0][1]);
        trip.DEST_STN ??= getSuburb(trip.STOPS[trip.STOPS.length - 1][1]);

        const row = document.createElement('tr');
        row.innerHTML = `
          <td><a href="#tripPatronage" class="trip" onclick="showTrip('${trip.TRIP_ID}')">${trip.TRIP_ID}</a></td>
          <td style="color:">${trip.ROUTE}</td>
          <td>${trip.DIRECTION}</td>
          <td>${trip.ORIG_STN}</td>
          <td>${trip.DEST_STN}</td>
          <td>${trip.TIME}</td>
          <td style="color: ${loadColour(trip.PEAK_LOAD, trip.CAPACITY)}">${loadPercentage(trip.PEAK_LOAD, trip.CAPACITY)}</td>
        `;
        tbody.appendChild(row);
      });

    // Create datatables with searchPane enabled
    $('#tripsTable').DataTable({
      dom: 'Plfrtip',
      searchPanes: {
        columns: [1, 2, 3, 4],
        dtOpts: {
          scrollY: '100px'
        },
        collapse: false,
      },
      order: [[5, 'asc']],
      columnDefs: [{ 
        targets: 6, 
        type: 'num-fmt',
        render: function ( data, type, row, meta ) {
          if ( type === 'display' && data === "0" ) {
            return "0-20";
          }
          return data;
        }
      },{
        targets: 2,
        render: function ( data, type, row, meta ) {
          if ( type === 'display') {
            if (["Up", "Inbound"].includes(data)) return "Towards City";
            if (["Down", "Outbound"].includes(data)) return "Away from City";
            return data;
          }
          return data;
        }
      }]
    });
  });
  
  function averageReducer(data, labels, step = 3) {
    const result = [];
    const resultLabels = [];
    step = Math.ceil(step);

    for (let i = 0; i < data.length; i += step) {
      const window = data.slice(i, i + step);
      const avg = window.reduce((a, b) => a + b, 0) / step;
      result.push(avg);
      resultLabels.push(labels[i])
    }

    if (data.length % step !== 1) {
      result.push(data[data.length - 1]);
      resultLabels.push(labels[labels.length - 1]);
    }

    return [result, resultLabels];
  }

  // Display a particular trip
  function showTrip(tripName) {
    const stopsTable = document.querySelector('#stopsTable tbody');
    stopsTable.innerHTML = '';

    const trip = database[tripName];
    let stations = [];
    let passengers = [];

    trip.STOPS.forEach(([i, stopId, timeSched, time, pax]) => {
      const station = stopList[stopId][0]
      const nextPax = trip.STOPS[i] ? trip.STOPS[i][4] || 0 : 0; // because i is the 1-indexed stop index
      const delta = nextPax - pax;

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${i}</td>
        <td>${station}</td>
        <td>${timeFormated(time)}</td>
        <td style="color:${loadColour(pax, trip.CAPACITY)}">${pax ? pax : "0-20"}</td>
        <td style="color:${loadColour(delta + trip.CAPACITY / 2, trip.CAPACITY)}">${delta > 0 ? "+" : ""}${delta}</td>
      `;
      stopsTable.appendChild(row);

      // For the graph
      stations.push(`${station} - ${timeFormated(time)}`);
      passengers.push(pax);
    });
    [passengers, stations] = averageReducer(passengers, stations, stations.length/GRAPH_MAX_POINTS );

    document.getElementById('tripData').style.display = 'block';
    document.getElementById("tripInfo").innerHTML = `
      Selected trip: ${trip.TRIP_ID} <br>
      ${trip.ROUTE} from ${trip.ORIG_STN} to ${trip.DEST_STN}, at ${timeFormated(trip.TIME)}<br>
      Bus type: ${trip.BUS_TYPE}<br>
      Total capacity: ${trip.CAPACITY}<br>
      Depot: ${trip.DEPOT}<br>
    `;

    const graph = document.getElementById('passengerGraph');
    if (passengers.every(n => n === 0)) {
      document.getElementById('tripInfo').innerHTML += "<br>Insufficient patronage to graph ðŸ˜”<br>"
      graph.style.display = 'none';
    } else {
      // Plot the passenger load graph
      graph.style.display = 'block';
      Plotly.newPlot(graph, [{
        x: stations,
        y: passengers,
        type: 'scatter',
        mode: 'lines+markers',
        line: { shape: 'spline' },
        fill: 'tozeroy',
      }], {
        title: `Passenger Load over time, ${trip.TRIP_ID}<br><sub>Departed ${trip.TIME}</sub>`,
        xaxis: { title: 'Station' },
        yaxis: { title: 'Passengers' }
      });
    }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/fflate/umd/index.js"></script>

<footer>
  <p>
    The information on this page is derived from data kindly provided by by Transport for NSW: 
    <a href="https://opendata.transport.nsw.gov.au/data/dataset/roam-bus-opal-assignment-model">BOAM</a>. <br>
    Transport uses Opal tap data to track how many passengers are taking services. 
    <br>
    If you find any issues, would like to see the code, or can help make the website better, contribute <a href="https://github.com/sudface/ROAM">here on github</a>.<br>
  </p>
  <hr>
  <p class="legal">
      Made with <a href="https://plotly.com/javascript/">Plotly.JS</a> and <a href="https://datatables.net/">DataTables</a>.<br>
      Please be aware that the data presented on this website is subject to potential inaccuracies. 
      While efforts have been made to ensure accuracy, we cannot guarantee the precision of the information.
      You are advised to exercise discretion and independently verify the data before making any decisions based on it. 
      The website owner and contributors are not liable for any consequences arising from the use of potentially inaccurate data.
      <br><br>
      This work is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
      You are free to:<br>
      - Share: Copy and redistribute the material in any medium or format.<br>
      - Adapt: Remix, transform, and build upon the material for any purpose.<br>
  </p>
</footer>
</body>

</html>