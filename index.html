<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ROAM Patronage Viewer</title>
  <style>
    :root {
      --main-color: #f37021;
      --dark-color: #db5705;
    }

    div#tripData, div#stationData {
      display: none;
    }

    table#stopsTable {
      width: 60%
    }
  </style>
  <link rel="stylesheet" href="./styles.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/searchpanes/2.1.2/css/searchPanes.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/searchpanes/2.1.2/js/dataTables.searchPanes.min.js"></script>
  <script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
  <script src="./scripts.js"></script>
</head>

<body>
<h1>NSW Public Transport Load Insights</h1>
<h2>Select a Dataset and Station</h2>

<div>
  <select id="modeSelect">
    <option value="">Select a mode...</option>
  </select>
  <select id="dateSelect" style="display: none;">
    <option value="">Select a date...</option>
  </select>
  <select id="stationSelect" style="display: none;">
    <option value="">Loading...</option>
  </select>
</div>

<div id="stationData">
  <h2>Trips Stopping Here</h2>
  <p>Select a trip to view further details.</p>
  <table id="tripsTable">
    <thead>
      <tr>
        <th>Trip</th>
        <th>Line</th>
        <th>Direction</th>
        <th>From</th>
        <th>To</th>
        <th>At</th>
        <th>Peak Load</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<div id="tripData">
  <h2 id="tripPatronage">Patronage for Selected Trip</h2>
  <div id="passengerGraph"></div>
  <p style="color: darkred">Note: Transport only provides data in resolutions of 20, rounded down.<br>Therefore, a patronage of "0" actually represents anywhere from "0-20" passengers</p>

  <hr>
  <br>
  <div id="tripInfo"></div>
  <table id="stopsTable">
    <thead>
      <tr>
        <th>Stop #</th>
        <th>Station</th>
        <th>Time</th>
        <th># Passengers on arrival</th>
        <th>âˆ† Passengers</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<!-- File Loading Logic -->
<script>
  let stationTriplist = {};
  let database = {};

  function loadJSON(filename) {
    document.getElementById('stationSelect').innerHTML = '<option value="">Loading...</option>';
    // Fetch trips JSON
    fetch(filename)
      .then(response => response.json())
      .then(trips => {
        // Build a map of station -> [tripname] for indexing on table
        stationTriplist = {};
        trips.forEach(trip => {
          if (doubleCapacityLines.includes(trip.LINE)) trip.SEAT_CAPACITY = trip.SEAT_CAPACITY * 2;
          trip.STOPS.forEach(([_, station]) => {
            if (!stationTriplist[station]) stationTriplist[station] = [];
            stationTriplist[station].push(trip.TRIP_NAME);
          });
        });

        // Restructure trip data so that key is the tripname for fast indexing
        database = Object.fromEntries(
          trips.map(trip => [trip.TRIP_NAME, trip])
        );

        // Show station selecter? selector? why are both correct
        const stationSelect = document.getElementById('stationSelect');
        stationSelect.innerHTML = '<option value="">Choose station</option>';
        Object.keys(stationTriplist).sort().forEach(station => {
          const option = document.createElement('option');
          option.value = station;
          option.textContent = station;
          stationSelect.appendChild(option);
        });
      })
  }

  const modeSelectPreFn = (selectedMode) => {
    if (selectedMode == "BOAM") window.location.href = './boam.html'
    const newURL = new URL(window.location.href);
    newURL.searchParams.set('mode', selectedMode); // set current mode in url
    window.history.replaceState({}, '', newURL); 

    setMainColour(OAMs[selectedMode][1]);
  }

  const defaultLogic = (modeSelect) => {
    const params = new URLSearchParams(window.location.search);
    const modeFromURL = params.get('mode'); // e.g., ?mode=ROAM autofil

    if (modeFromURL) {
      modeSelect.value = modeFromURL;
      if (!modeSelect.value) modeSelect.selectedIndex = 0; // fallback
      modeSelect.dispatchEvent(new Event('change'));
    }
  }

  loadDirectory("stationSelect", modeSelectPreFn, defaultLogic);
</script>

<!-- Data Vis Logic -->
<script>
  const timeFormated = (dateStr) => new Intl.DateTimeFormat('en-US', { hour: '2-digit', minute: '2-digit', hour12: false })
    .format(new Date(dateStr.replace(" ", "T")))
    .toLowerCase();

  // Handle station selection
  document.getElementById('stationSelect').addEventListener('change', () => {
    const station = document.getElementById('stationSelect').value;
    const tbody = document.querySelector('#tripsTable tbody');
    tbody.innerHTML = '';

    // Destroy datatables and clear current trip data
    const dataTable = $('#tripsTable').DataTable();
    dataTable.clear().destroy();
    document.getElementById('tripInfo').innerHTML = '';
    document.querySelector('#stopsTable tbody').innerHTML = '';
    document.getElementById('tripData').style.display = 'none';
    document.getElementById("stationData").style.display = "inline";

    // Get trips of that station and then sort and then tabulate
    const sortedTrips = stationTriplist[station]
      .map(i => database[i])
      .sort((a, b) => new Date(a.STOPS.filter(v => v[1] == station)[0][2]) - new Date(b.STOPS.filter(v => v[1] == station)[0][2]))
      .forEach(trip => {
        const maxLoad = Math.max(...trip.STOPS.map(stop => stop[3] || 0)); // Calculate max load
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><a href="#tripPatronage" class="trip" onclick="showTrip('${trip.TRIP_NAME}')">${trip.TRIP_NAME}</a></td>
          <td style="color: ${lineColours[trip.LINE]}">${trip.LINE}</td>
          <td>${trip.SEGMENT_DIRECTION}</td>
          <td>${trip.ORIG_STN}</td>
          <td>${trip.DEST_STN}</td>
          <td>${timeFormated(trip.STOPS.filter(v => v[1] == station)[0][2])}</td>
          <td style="color: ${loadColour(maxLoad, trip.SEAT_CAPACITY)}">${maxLoad}</td>
        `;
        tbody.appendChild(row);
      });

      initDatatables();
    });

  // Display a particular trip
  function showTrip(tripName) {
    const stopsTable = document.querySelector('#stopsTable tbody');
    stopsTable.innerHTML = '';

    const trip = database[tripName];
    const stations = [];
    const passengers = [];

    trip.STOPS.forEach(([i, station, time, pax]) => {
      const nextPax = trip.STOPS[i] ? trip.STOPS[i][3] || 0 : 0; // because i is the 1-indexed stop index
      const delta = nextPax - pax;

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${i}</td>
        <td>${station}</td>
        <td>${timeFormated(time)}</td>
        <td style="color:${loadColour(pax, trip.SEAT_CAPACITY)}">${pax ? pax : "0-20"}</td>
        <td style="color:${loadColour(delta + trip.SEAT_CAPACITY / 2, trip.SEAT_CAPACITY)}">${delta > 0 ? "+" : ""}${delta}</td>
      `;
      stopsTable.appendChild(row);

      // For the graph
      stations.push(`${station} - ${timeFormated(time)}`);
      passengers.push(pax);
    });
    passengers.push(0);
    passengers.shift();

    document.getElementById('tripData').style.display = 'block';
    document.getElementById("tripInfo").innerHTML = `
      Selected trip: ${trip.TRIP_NAME} <br>
      ${trip.LINE} from ${trip.ORIG_STN} to ${trip.DEST_STN} <br>
      Departed ${trip.TIME}<br>
      Total seat capacity: ${doubleCapacityLines.includes(trip.LINE) ? trip.SEAT_CAPACITY / 2 : trip.SEAT_CAPACITY}<br>
    `;

    const graph = document.getElementById('passengerGraph');
    if (passengers.every(n => n === 0)) {
      document.getElementById('tripInfo').innerHTML += "<br>Insufficient patronage to graph ðŸ˜”<br>"
      graph.style.display = 'none';
    } else {
      // Plot the passenger load graph
      graph.style.display = 'block';
      Plotly.newPlot(graph, [{
        x: stations,
        y: passengers,
        type: 'scatter',
        mode: 'lines+markers',
        marker: { color: lineColours[trip.LINE] },
        line: { shape: 'linear' },
        fill: 'tozeroy',
      }], {
        title: `Passenger Load over time, ${trip.TRIP_NAME}<br><sub>Departed ${trip.TIME}</sub>`,
        xaxis: { title: 'Station' },
        yaxis: { title: 'Passengers' }
      });
    }
  };
</script>

<footer>
  <p>
    The information on this page is derived from data kindly provided by by Transport for NSW: 
    <a href="https://opendata.transport.nsw.gov.au/data/dataset/roam-rail-opal-assignment-model">ROAM</a> and 
    <a href="https://opendata.transport.nsw.gov.au/data/dataset/loam-light-rail-opal-assignment-model">LOAM</a> and
    <a href="https://opendata.transport.nsw.gov.au/data/dataset/foam-ferry-opal-assignment-model">FOAM</a>. 
    Transport uses Opal tap data to estimate what services passengers are taking. 
    <br>
    If you find any issues, would like to see the code, or can help make the website better, contribute <a href="https://github.com/sudface/ROAM">here on github</a>.<br>
  </p>
  <hr>
  <p class="legal">
      Made with <a href="https://plotly.com/javascript/">Plotly.JS</a> and <a href="https://datatables.net/">DataTables</a>.<br>
      Please be aware that the data presented on this website is subject to potential inaccuracies. 
      While efforts have been made to ensure accuracy, we cannot guarantee the precision of the information.
      You are advised to exercise discretion and independently verify the data before making any decisions based on it. 
      The website owner and contributors are not liable for any consequences arising from the use of potentially inaccurate data.
      <br><br>
      This work is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
      You are free to:<br>
      - Share: Copy and redistribute the material in any medium or format.<br>
      - Adapt: Remix, transform, and build upon the material for any purpose.<br>
  </p>
</footer>
</body>

</html>