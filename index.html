<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ROAM Patronage Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    select,
    table {
      margin-top: 10px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f4f4f4;
    }

    footer {
      margin-top: 5%
    }
  </style>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/searchpanes/2.1.2/css/searchPanes.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/searchpanes/2.1.2/js/dataTables.searchPanes.min.js"></script>
<script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>
</head>

<body>

<h1>Select a Station</h1>

<select id="stationSelect">
  <option value="">Loading...</option>
</select>

<h2>Patronage for Selected Trip</h2>
<div id="tripInfo"></div>
<table id="stopsTable">
  <thead>
    <tr>
      <th>Stop #</th>
      <th>Station</th>
      <th>Time</th>
      <th># Passengers</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

<h2>Trips Stopping Here</h2>
<table id="tripsTable">
  <thead>
    <tr>
      <th>Trip</th>
      <th>Line</th>
      <th>Direction</th>
      <th>From</th>
      <th>To</th>
      <th>At</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

<script>
  let stationTriplist = {};
  let database = {};
  const lineColours = {"M": "#168388", "T1 North Shore": "#f89c1c", "T1 Western": "#f89c1c", "T2": "#0097cd", "T3": "#f35e21", "T4": "#015aa5", "T5": "#c32190", "T6": "#4f6dab", "T7": "#6e818e", "T8": "#00964c", "T9": "#d21f2f", "BMT": "#f89c1c", "SCO": "#015aa5", "SHL": "#00964c", "CCN": "#d21f2f", "HUN": "#833033", "CX": "#4b5055"};

  const timeFormated = (dateStr) => new Intl.DateTimeFormat('en-US', { hour: '2-digit', minute: '2-digit', hour12: false })
    .format(new Date(dateStr.replace(" ", "T")))
    .toLowerCase();

  // Fetch trips JSON
  fetch('ROAM_20250822.json')
    .then(response => response.json())
    .then(trips => {
      // Build a map of station -> [tripname] for indexing on table
      trips.forEach(trip => {
        trip.STOPS.forEach(([_, station]) => {
          if (!stationTriplist[station]) stationTriplist[station] = [];
          stationTriplist[station].push(trip.TRIP_NAME);
        });
      });

      // Restructure trip data so that key is the tripname for fast indexing
      database = Object.fromEntries(
        trips.map(trip => [trip.TRIP_NAME, trip])
      );

      // Show station selecter? selector? why are both correct
      const stationSelect = document.getElementById('stationSelect');
      stationSelect.innerHTML = '<option value="">Choose station</option>';
      Object.keys(stationTriplist).sort().forEach(station => {
        const option = document.createElement('option');
        option.value = station;
        option.textContent = station;
        stationSelect.appendChild(option);
      });
    })

  // Handle station selection
  document.getElementById('stationSelect').addEventListener('change', () => {
    const station = document.getElementById('stationSelect').value;
    const tbody = document.querySelector('#tripsTable tbody');
    tbody.innerHTML = '';

    // Destroy datatables and clear current trip data
    const dataTable = $('#tripsTable').DataTable();
    dataTable.clear().destroy();
    document.getElementById('tripInfo').innerHTML = '';
    document.querySelector('#stopsTable tbody').innerHTML = '';

    // Get trips of that station and then sort and then tabulate
    const sortedTrips = stationTriplist[station]
      .map(i => database[i])
      .sort((a, b) => new Date(a.STOPS.filter(v => v[1] == station)[0][2]) - new Date(b.STOPS.filter(v => v[1] == station)[0][2]))
      .forEach(trip => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><a href="#" class="trip" onclick="showTrip('${trip.TRIP_NAME}')">${trip.TRIP_NAME}</a></td>
          <td style="color: ${lineColours[trip.LINE]}">${trip.LINE}</td>
          <td>${trip.SEGMENT_DIRECTION}</td>
          <td>${trip.ORIG_STN}</td>
          <td>${trip.DEST_STN}</td>
          <td>${timeFormated(trip.STOPS.filter(v => v[1] == station)[0][2])}</td>
        `;
        tbody.appendChild(row);
      });

    // Create datatables with searchPane enabled
    $('#tripsTable').DataTable({
      dom: 'Plfrtip',
      searchPanes: {
        columns: [1, 2, 3, 4]
      },
      order: [[5, 'asc']]
    });
  });

  // Display a particular trip
  function showTrip(tripName) {
    const stopsTable = document.querySelector('#stopsTable tbody');
    stopsTable.innerHTML = '';

    const trip = database[tripName];
    trip.STOPS.forEach(([i, station, time, pax]) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${i}</td>
        <td>${station}</td>
        <td>${timeFormated(time)}</td>
        <td>${pax ? pax : "0-20"}</td>
      `;
      stopsTable.appendChild(row);
    });
    document.getElementById("tripInfo").innerHTML = `
      Selected trip: ${trip.TRIP_NAME} <br>
      ${trip.LINE} from ${trip.DEST_STN} to ${trip.ORIG_STN} <br>
      Departed ${trip.TIME}<br>
      Total capacity: ${trip.CAPACITY}
      `
  };
</script>

<footer>
  Data from <a href="https://opendata.transport.nsw.gov.au/data/dataset/roam-rail-opal-assignment-model/">ROAM - Transport for NSW</a>.<br>
  View the processing code <a href="./processROAM.py">here</a>.<br>

</footer>
</body>

</html>