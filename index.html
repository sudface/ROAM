<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ROAM Patronage Viewer</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background-color: #f9f9f9;
      color: #333;
      line-height: 1.6;
    }

    h2 {
      color: #444;
      border-bottom: 2px solid #f37021;
      padding-bottom: 5px;
    }

    select {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
      background-color: #fff;
      transition: border-color 0.3s;
    }

    select:focus {
      border-color: #f37021;
      outline: none;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background-color: #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }

    th {
      background-color: #f4f4f4;
      color: #555;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tr:hover {
      background-color: #f1f1f1;
    }

    a.trip {
      color: #f37021;
      text-decoration: none;
      font-weight: bold;
    }

    a.trip:hover {
      text-decoration: underline;
    }

    footer {
      margin-top: 5%;
      padding: 20px;
      background-color: #f4f4f4;
      border-top: 1px solid #ddd;
      text-align: center;
    }

    footer a {
      color: #f37021;
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    p.legal {
      font-size: 0.9rem;
      color: #666;
    }

    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      background-color: #f37021;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #d65c1a;
    }

    div#passengerGraph {
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #fff;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      width: 100%;
      height: 400px;
    }

    div#tripData, div#stationData {
      display: none;
    }
  </style>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/searchpanes/2.1.2/css/searchPanes.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/searchpanes/2.1.2/js/dataTables.searchPanes.min.js"></script>
<script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
</head>

<body>

<h2>Select a Dataset and Station</h2>

<div>
  <select id="modeSelect">
    <option value="">Select a mode...</option>
  </select>
  <select id="dateSelect" style="display: none;">
    <option value="">Select a date...</option>
  </select>
  <select id="stationSelect" style="display: none;">
    <option value="">Loading...</option>
  </select>
</div>

<div id="stationData">
  <h2>Trips Stopping Here</h2>
  <table id="tripsTable">
    <thead>
      <tr>
        <th>Trip</th>
        <th>Line</th>
        <th>Direction</th>
        <th>From</th>
        <th>To</th>
        <th>At</th>
        <th>Peak Load</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<div id="tripData">
  <h2 id="tripPatronage">Patronage for Selected Trip</h2>
  <div id="passengerGraph"></div>
  <p style="color: darkred">Note: Transport only provides data in resolutions of 20, rounded down.<br>Therefore, a patronage of "0" actually represents anywhere from "0-20" passengers</p>

  <hr>
  <br>
  <div id="tripInfo"></div>
  <table id="stopsTable">
    <thead>
      <tr>
        <th>Stop #</th>
        <th>Station</th>
        <th>Time</th>
        <th># Passengers on arrival</th>
        <th>âˆ† Passengers</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<!-- File Loading Logic -->
<script>
  let stationTriplist = {};
  let database = {};

  function loadJSON(filename) {
    document.getElementById('stationSelect').innerHTML = '<option value="">Loading...</option>';
    // Fetch trips JSON
    fetch(filename)
      .then(response => response.json())
      .then(trips => {
        // Build a map of station -> [tripname] for indexing on table
        stationTriplist = {};
        trips.forEach(trip => {
          if (doubleCapacityLines.includes(trip.LINE)) trip.SEAT_CAPACITY = trip.SEAT_CAPACITY * 2;
          trip.STOPS.forEach(([_, station]) => {
            if (!stationTriplist[station]) stationTriplist[station] = [];
            stationTriplist[station].push(trip.TRIP_NAME);
          });
        });

        // Restructure trip data so that key is the tripname for fast indexing
        database = Object.fromEntries(
          trips.map(trip => [trip.TRIP_NAME, trip])
        );

        // Show station selecter? selector? why are both correct
        const stationSelect = document.getElementById('stationSelect');
        stationSelect.innerHTML = '<option value="">Choose station</option>';
        Object.keys(stationTriplist).sort().forEach(station => {
          const option = document.createElement('option');
          option.value = station;
          option.textContent = station;
          stationSelect.appendChild(option);
        });
      })
  }

  // Format 20250822 -> 22 Aug 2025
  const formatDate = yyyymmdd => {
    const [y, m, d] = [yyyymmdd.slice(0,4), yyyymmdd.slice(4,6), yyyymmdd.slice(6,8)];
    const date = new Date(parseInt(y), parseInt(m) - 1, parseInt(d))
    return [date, `${date.toLocaleString('en-US', { weekday: 'short' })} ${d} ${date.toLocaleString('en-US', { month: 'short' })} ${y}`]
  }

  // Fetch directory.json and populate mode and date selects
  fetch('./processed/directory.json')
    .then(res => res.json())
    .then(data => {
      const modeSelect = document.getElementById('modeSelect');
      const dateSelect = document.getElementById('dateSelect');
      const OAMs = {
        "ROAM": ["Trains", "#F37021"],
        "FOAM": ["Ferries", "#00774B"],
        "LOAM": ["Light Rail", "#BE1622"],
      };

      // Flatten files with path and group by mode
      // This method was so new that my vscode JS engine didn't even know about it
      // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/groupBy
      const groupedFiles = Object.groupBy(
        Object.entries(data)
          .flatMap(([dir, files]) => files.map(file => dir + file))
          .map(path => {
            const match = path.match(/([LRFB]OAM)_(\d{8})\.json/);
            if (!match) return null;
            const [_, type, dateStr] = match;
            return {path, type, dateStr, date: formatDate(dateStr)[0]};
          })
          .filter(Boolean),
          ({type}) => type // This is some wild syntax
      )

      // Populate mode dropdown
      Object.keys(groupedFiles).forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = OAMs[type][0];
        option.style.color = OAMs[type][1];
        modeSelect.appendChild(option);
      });

      // Handle mode selection
      modeSelect.addEventListener('change', () => {
        const selectedMode = modeSelect.value;
        dateSelect.innerHTML = '<option value="">Select a date...</option>';
        dateSelect.style.display = 'inline';

        groupedFiles[selectedMode]
          .sort((a, b) => b.date - a.date)
          .forEach(({path, dateStr}) => {
            const option = document.createElement('option');
            option.value = path;
            option.textContent = formatDate(dateStr)[1];
            dateSelect.appendChild(option);
          });

        // Hide all data, have only mode selector showing
        document.getElementById("stationSelect").style.display = "none";
        document.getElementById("stationData").style.display = "none";
        document.getElementById("tripData").style.display = "none";
      });

      // Handle date selection
      dateSelect.addEventListener('change', () => {
        const selectedFile = dateSelect.value;
        if (selectedFile) {
          loadJSON(selectedFile);
          document.getElementById("stationSelect").style.display = "inline";
        }
      });
    });
</script>

<!-- Data Vis Logic -->
<script>
  const lineColours = {
    "T1 North Shore": "#f89c1c", "T1 Western": "#f89c1c", "T2": "#0097cd", "T3": "#f35e21", "T4": "#015aa5", 
    "T5": "#c32190", "T6": "#4f6dab", "T7": "#6e818e", "T8": "#00964c", "T9": "#d21f2f", 
    "BMT": "#f89c1c", "SCO": "#015aa5", "SHL": "#00964c", "CCN": "#d21f2f", "HUN": "#833033", "M": "#168388", 
    "L1": "#BE1622", "L2": "#DD1E25", "L3": "#781140", "L4": "#BE1622", "NLR": "#EE343F",
    "F1": "#00774B", "F2": "#144734", "F3": "#648C3C", "F4": "#BFD730", "F5": "#286142", "F6": "#00AB51", 
    "F7": "#00B189", "F8": "#55622B", "F9": "#65B32E", "F10": "#5AB031" , "Stockton Ferry": "#5AB031", "MFF": "#3a78b6"
  };

  const doubleCapacityLines = ["M1", "L2", "L3"]

  const timeFormated = (dateStr) => new Intl.DateTimeFormat('en-US', { hour: '2-digit', minute: '2-digit', hour12: false })
    .format(new Date(dateStr.replace(" ", "T")))
    .toLowerCase();

    function loadColour(load, capacity) {
      const ratio = load / capacity;
      if (ratio <= 0.25) return "green";
      if (ratio <= 0.5) return "orange";
      if (ratio <= 0.75) return "red";
      return "maroon";
    }

  // Handle station selection
  document.getElementById('stationSelect').addEventListener('change', () => {
    const station = document.getElementById('stationSelect').value;
    const tbody = document.querySelector('#tripsTable tbody');
    tbody.innerHTML = '';

    // Destroy datatables and clear current trip data
    const dataTable = $('#tripsTable').DataTable();
    dataTable.clear().destroy();
    document.getElementById('tripInfo').innerHTML = '';
    document.querySelector('#stopsTable tbody').innerHTML = '';
    document.getElementById('tripData').style.display = 'none';
    document.getElementById("stationData").style.display = "inline";

    // Get trips of that station and then sort and then tabulate
    const sortedTrips = stationTriplist[station]
      .map(i => database[i])
      .sort((a, b) => new Date(a.STOPS.filter(v => v[1] == station)[0][2]) - new Date(b.STOPS.filter(v => v[1] == station)[0][2]))
      .forEach(trip => {
        const maxLoad = Math.max(...trip.STOPS.map(stop => stop[3] || 0)); // Calculate max load
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><a href="#tripPatronage" class="trip" onclick="showTrip('${trip.TRIP_NAME}')">${trip.TRIP_NAME}</a></td>
          <td style="color: ${lineColours[trip.LINE]}">${trip.LINE}</td>
          <td>${trip.SEGMENT_DIRECTION}</td>
          <td>${trip.ORIG_STN}</td>
          <td>${trip.DEST_STN}</td>
          <td>${timeFormated(trip.STOPS.filter(v => v[1] == station)[0][2])}</td>
          <td style="color: ${loadColour(maxLoad, trip.SEAT_CAPACITY)}">${maxLoad}</td>
        `;
        tbody.appendChild(row);
      });

    // Create datatables with searchPane enabled
    $('#tripsTable').DataTable({
      dom: 'Plfrtip',
      searchPanes: {
        columns: [1, 2, 3, 4]
      },
      order: [[5, 'asc']],
      columnDefs: [{ 
        targets: 6, 
        type: 'num-fmt',
        render: function ( data, type, row, meta ) {
          if ( type === 'display' && data === "0" ) {
            return "0-20";
          }
          return data;
      }
      }]
    });
  });

  // Display a particular trip
  function showTrip(tripName) {
    const stopsTable = document.querySelector('#stopsTable tbody');
    stopsTable.innerHTML = '';

    const trip = database[tripName];
    const stations = [];
    const passengers = [];

    trip.STOPS.forEach(([i, station, time, pax]) => {
      const nextPax = trip.STOPS[i] ? trip.STOPS[i][3] || 0 : 0; // because i is the 1-indexed stop index
      const delta = nextPax - pax;

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${i}</td>
        <td>${station}</td>
        <td>${timeFormated(time)}</td>
        <td style="color:${loadColour(pax, trip.SEAT_CAPACITY)}">${pax ? pax : "0-20"}</td>
        <td style="color:${loadColour(delta + trip.SEAT_CAPACITY / 2, trip.SEAT_CAPACITY)}">${delta > 0 ? "+" : ""}${delta}</td>
      `;
      stopsTable.appendChild(row);

      // For the graph
      stations.push(`${station} - ${timeFormated(time)}`);
      passengers.push(pax);
    });
    passengers.push(0);
    passengers.shift();

    document.getElementById('tripData').style.display = 'block';
    document.getElementById("tripInfo").innerHTML = `
      Selected trip: ${trip.TRIP_NAME} <br>
      ${trip.LINE} from ${trip.ORIG_STN} to ${trip.DEST_STN} <br>
      Departed ${trip.TIME}<br>
      Total seat capacity: ${doubleCapacityLines.includes(trip.LINE) ? trip.SEAT_CAPACITY / 2 : trip.SEAT_CAPACITY}<br>
    `;

    const graph = document.getElementById('passengerGraph');
    if (passengers.every(n => n === 0)) {
      document.getElementById('tripInfo').innerHTML += "<br>Insufficient patronage to graph ðŸ˜”<br>"
      graph.style.display = 'none';
    } else {
      // Plot the passenger load graph
      graph.style.display = 'block';
      Plotly.newPlot(graph, [{
        x: stations,
        y: passengers,
        type: 'scatter',
        mode: 'lines+markers',
        marker: { color: lineColours[trip.LINE] },
        line: { shape: 'linear' },
        fill: 'tozeroy',
      }], {
        title: `Passenger Load over time, ${trip.TRIP_NAME}<br><sub>Departed ${trip.TIME}</sub>`,
        xaxis: { title: 'Station' },
        yaxis: { title: 'Passengers' }
      });
    }
  };
</script>

<footer>
  <p>
    The information on this page is derived from data kindly provided by by Transport for NSW: <a href="https://opendata.transport.nsw.gov.au/data/dataset/roam-rail-opal-assignment-model">ROAM</a> and <a href="https://opendata.transport.nsw.gov.au/data/dataset/loam-light-rail-opal-assignment-model">LOAM</a>. Transport uses Opal tap data to estimate what services passengers are taking. 
    <br><br>
    If you find any issues, would like to see the code, or think you can make the website better, contribute <a href="https://github.com/sudface/ROAM">here on github</a>.<br>
  </p>
  <hr>
  <p class="legal">
      Made with <a href="https://plotly.com/javascript/">Plotly.JS</a> and <a href="https://datatables.net/">DataTables</a>.<br>
      Please be aware that the data presented on this website is subject to potential inaccuracies. 
      While efforts have been made to ensure accuracy, we cannot guarantee the precision of the information.
      You are advised to exercise discretion and independently verify the data before making any decisions based on it. 
      The website owner and contributors are not liable for any consequences arising from the use of potentially inaccurate data.
      <br><br>
      This work is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
      You are free to:<br>
      - Share: Copy and redistribute the material in any medium or format.<br>
      - Adapt: Remix, transform, and build upon the material for any purpose.<br>
  </p>
</footer>
</body>

</html>